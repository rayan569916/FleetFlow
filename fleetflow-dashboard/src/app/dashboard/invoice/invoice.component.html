<div class="invoice-wrapper">
  <!-- MESSAGES REMOVED (Replaced by Toast) -->

  <!-- LIST VIEW -->
  <div *ngIf="viewMode === 'list'" class="invoice-container">
    <div class="invoice-header">
      <h1>Invoices</h1>
      <button class="btn btn-primary" (click)="switchToCreate()">Create New Invoice</button>
    </div>

    <div class="items-table-wrapper" *ngIf="invoices.length > 0; else noInvoices">
      <table class="items-table">
        <thead>
          <tr>
            <th>Invoice #</th>
            <th>Tracking #</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Description</th>
            <th>Status</th>
            <th>Created By</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let inv of invoices">
            <td>{{ inv.invoice_number }}</td>
            <td class="font-mono text-xs">{{ inv.tracking_number || '-' }}</td>
            <td>{{ inv.date | date }}</td>
            <td>{{ settingsService.currencySymbol() }}{{ inv.amount.toFixed(2) }}</td>
            <td>{{ inv.description }}</td>
            <td>
              <!-- Status Dropdown (only for admins/accountants) -->
              <select
                *ngIf="
                  currentUserRole === 'super_admin' ||
                    currentUserRole === 'ceo' ||
                    currentUserRole === 'accountant';
                  else statusBadge
                "
                [value]="inv.status"
                (change)="updateInvoiceStatus(inv.id!, $event)"
                class="status-select"
                [ngClass]="{
                  'bg-yellow-100 text-yellow-800': inv.status === 'Pending',
                  'bg-green-100 text-green-800': inv.status === 'Paid',
                  'bg-red-100 text-red-800': inv.status === 'Canceled',
                }"
              >
                <option value="Pending">Pending</option>
                <option value="Paid">Paid</option>
                <option value="Canceled">Canceled</option>
              </select>
              <ng-template #statusBadge>
                <span
                  class="px-2 py-1 rounded text-xs font-semibold"
                  [ngClass]="{
                    'bg-yellow-100 text-yellow-800': inv.status === 'Pending',
                    'bg-green-100 text-green-800': inv.status === 'Paid',
                    'bg-red-100 text-red-800': inv.status === 'Canceled',
                  }"
                >
                  {{ inv.status }}
                </span>
              </ng-template>
            </td>
            <td>{{ inv.full_name || 'N/A' }}</td>
            <td class="flex gap-2">
              <button class="btn btn-secondary btn-sm" (click)="viewInvoice(inv.id!)">View</button>
              <button
                *ngIf="currentUserRole === 'super_admin' || currentUserRole === 'ceo'"
                class="btn btn-danger btn-sm"
                (click)="deleteInvoice(inv.id!)"
              >
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noInvoices>
      <div class="no-items-message">
        <p *ngIf="!isLoading">No invoices found.</p>
        <p *ngIf="isLoading">Loading invoices...</p>
      </div>
    </ng-template>
  </div>

  <!-- DETAILS / PRINT VIEW -->
  <div *ngIf="viewMode === 'details' && selectedInvoice" class="invoice-container print-container">
    <div class="invoice-header no-print">
      <h1>Invoice Details</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="switchToList()">Back to List</button>
        <button class="btn btn-primary" (click)="printInvoice()">Print</button>
      </div>
    </div>

    <div class="invoice-paper bg-white p-8 shadow-lg rounded-lg w-full" id="printable-area">
      <!-- Printable Header -->
      <div class="flex justify-between items-start mb-8 border-b pb-6">
        <div>
          <h2 class="text-3xl font-bold text-gray-800">INVOICE</h2>
          <p class="text-gray-500 mt-1">#{{ selectedInvoice.invoice_number }}</p>
        </div>
        <div class="text-right">
          <div class="text-xl font-bold text-indigo-600 mb-1">Captain Cargo</div>
          <p class="text-sm text-gray-600">Transportation Management</p>
          <p class="text-sm text-gray-600">Date: {{ selectedInvoice.date | date: 'mediumDate' }}</p>
          <p class="text-sm text-gray-600 font-semibold mt-2">
            Status:
            <span
              [class.text-green-600]="selectedInvoice.status === 'Paid'"
              [class.text-red-600]="selectedInvoice.status === 'Pending'"
              >{{ selectedInvoice.status }}</span
            >
          </p>
        </div>
      </div>

      <!-- Addresses -->
      <div class="grid grid-cols-2 gap-8 mb-8">
        <div>
          <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
            Billed To
          </h3>
          <div class="text-sm text-gray-800" *ngIf="selectedInvoice.invoice_details as d">
            <p class="font-bold text-lg">{{ d.consigneeName }}</p>
            <p>{{ d.consigneeAddress }}</p>
            <p>Tel: {{ d.consigneeMobile }}</p>
          </div>
        </div>
        <div class="text-right">
          <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
            Shipped From
          </h3>
          <div class="text-sm text-gray-800" *ngIf="selectedInvoice.invoice_details as d">
            <p class="font-bold text-lg">{{ d.customerName }}</p>
            <p>{{ d.address }}</p>
            <p>{{ d.city }} - {{ d.zipCode }}</p>
            <p>Tel: {{ d.phone }}</p>
            <p>{{ d.email }}</p>
          </div>
        </div>
      </div>

      <div class="mb-8" *ngIf="selectedInvoice.invoice_details as d">
        <div class="grid grid-cols-2 gap-4 text-sm bg-gray-50 p-4 rounded-lg">
          <div>
            <span class="text-gray-500">Tracking Number:</span>
            <span class="font-semibold ml-2">{{ selectedInvoice.tracking_number || '-' }}</span>
          </div>
          <div>
            <span class="text-gray-500">Mode of Delivery:</span>
            <span class="font-semibold ml-2">{{ d.modeOfDelivery || 'N/A' }}</span>
          </div>
          <div>
            <span class="text-gray-500">Mode of Payment:</span>
            <span class="font-semibold ml-2">{{ d.modeOfPayment || 'N/A' }}</span>
          </div>
          <div>
            <span class="text-gray-500">Total Cartons:</span>
            <span class="font-semibold ml-2">{{ d.totalCartons || d.numberOfCartons || 0 }}</span>
          </div>
          <div>
            <span class="text-gray-500">Total Weight:</span>
            <span class="font-semibold ml-2">{{ d.totalWeight || 0 }} kg</span>
          </div>
          <div *ngIf="d.pricePerKg">
            <span class="text-gray-500">Price per kg:</span>
            <span class="font-semibold ml-2"
              >{{ settingsService.currencySymbol() }}{{ d.pricePerKg }}</span
            >
          </div>
        </div>
      </div>

      <!-- Items Table -->
      <table class="w-full mb-8">
        <thead>
          <tr class="border-b-2 border-gray-200">
            <th class="text-left py-3 text-sm font-semibold text-gray-600">Description</th>
            <th class="text-right py-3 text-sm font-semibold text-gray-600">Qty</th>
            <th class="text-right py-3 text-sm font-semibold text-gray-600">Unit Weight (kg)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Check if we have item details -->
          <ng-container *ngIf="selectedInvoice.invoice_details?.items; else noItemDetails">
            <tr
              *ngFor="let item of selectedInvoice.invoice_details.items"
              class="border-b border-gray-100"
            >
              <td class="py-3 text-sm text-gray-800">{{ item.description }}</td>
              <td class="py-3 text-sm text-gray-800 text-right">{{ item.quantity }}</td>
              <td class="py-3 text-sm text-gray-800 text-right">{{ item.unitWeight || '-' }}</td>
            </tr>
          </ng-container>
          <ng-template #noItemDetails>
            <!-- Fallback if old invoice format -->
            <tr>
              <td colspan="3" class="py-4 text-center text-gray-500 italic">
                Item details not available for this invoice.
              </td>
            </tr>
          </ng-template>
        </tbody>
      </table>

      <!-- Totals -->
      <div class="flex justify-end">
        <div class="w-64 space-y-2">
          <!-- We can try to use saved totals or just re-calculate/display fields -->
          <ng-container *ngIf="selectedInvoice.invoice_details as d">
            <div class="flex justify-between text-sm text-gray-600" *ngIf="d.customsCharge > 0">
              <span>Customs:</span>
              <span>+{{ settingsService.currencySymbol() }}{{ d.customsCharge }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-600" *ngIf="d.billCharge > 0">
              <span>Bill Charge:</span>
              <span>+{{ settingsService.currencySymbol() }}{{ d.billCharge }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-600" *ngIf="d.packingCharge > 0">
              <span>Packing:</span>
              <span>+{{ settingsService.currencySymbol() }}{{ d.packingCharge }}</span>
            </div>
            <div class="flex justify-between text-sm text-gray-600" *ngIf="d.discount > 0">
              <span>Discount:</span>
              <span>-{{ settingsService.currencySymbol() }}{{ d.discount }}</span>
            </div>
          </ng-container>

          <div class="flex justify-between text-lg font-bold border-t pt-2">
            <span>Grand Total:</span>
            <span
              >{{ settingsService.currencySymbol() }}{{ selectedInvoice.amount.toFixed(2) }}</span
            >
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="mt-12 pt-8 border-t text-center text-gray-500 text-xs">
        <p>Thank you for your business!</p>
      </div>
    </div>
  </div>

  <!-- CREATE VIEW -->
  <div *ngIf="viewMode === 'create'" class="invoice-container compact-create">
    <div class="invoice-header">
      <h1>New Billing Invoice</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="switchToList()">Back to List</button>
        <button class="btn btn-primary" (click)="printInvoice()">Print</button>
        <button class="btn btn-secondary" (click)="resetFormBasedOnButton()">Reset</button>
      </div>
    </div>

    <!-- USER INFORMATION SECTION -->
    <div class="section user-info-section">
      <h2>Invoice Information</h2>
      <form [formGroup]="userInfoForm" class="user-info-form">
        <div class="form-two-columns m-0 gap-1">
          <!-- LEFT COLUMN -->
          <div class="form-column">
            <h3 class="sub-heading">Sender / Shipper</h3>

            <div class="flex gap-1 mb-1">
              <!-- Tracking -->
              <div class="floating-group">
                <input
                  type="text"
                  formControlName="trackingNumber"
                  placeholder=" "
                  class="floating-input text-black"
                />
                <label class="floating-label">Tracking Number</label>
              </div>

              <!-- Sender Name -->
              <div class="floating-group">
                <input
                  type="text"
                  formControlName="customerName"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('customerName')?.invalid &&
                    userInfoForm.get('customerName')?.touched
                  "
                />
                <label class="floating-label">Sender Name *</label>
              </div>

              <!-- Phone -->
              <div class="floating-group">
                <input
                  type="tel"
                  formControlName="phone"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('phone')?.invalid && userInfoForm.get('phone')?.touched
                  "
                />
                <label class="floating-label">Phone *</label>
              </div>
            </div>

            <!-- Address -->
            <div class="flex gap-1 mb-1">
              <div class="floating-group full-width">
                <input
                  type="text"
                  formControlName="address"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('address')?.invalid && userInfoForm.get('address')?.touched
                  "
                />
                <label class="floating-label">Address *</label>
              </div>
            </div>

            <!-- City / Zip -->
            <div class="flex gap-1 mb-1">
              <div class="floating-group">
                <input
                  type="text"
                  formControlName="city"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('city')?.invalid && userInfoForm.get('city')?.touched
                  "
                />
                <label class="floating-label">City *</label>
              </div>

              <div class="floating-group">
                <input
                  type="text"
                  formControlName="zipCode"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('zipCode')?.invalid && userInfoForm.get('zipCode')?.touched
                  "
                />
                <label class="floating-label">Zip Code *</label>
              </div>
            </div>

            <!-- Email -->
            <div class="flex gap-1 mb-1">
              <div class="floating-group full-width">
                <input
                  type="email"
                  formControlName="email"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('email')?.invalid && userInfoForm.get('email')?.touched
                  "
                />
                <label class="floating-label">Email *</label>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div class="form-column">
            <h3 class="sub-heading">Consignee</h3>

            <div class="flex gap-1 mb-1">
              <div class="floating-group">
                <input
                  type="text"
                  formControlName="consigneeName"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('consigneeName')?.invalid &&
                    userInfoForm.get('consigneeName')?.touched
                  "
                />
                <label class="floating-label">Consignee Name *</label>
              </div>

              <div class="floating-group">
                <input
                  type="tel"
                  formControlName="consigneeMobile"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('consigneeMobile')?.invalid &&
                    userInfoForm.get('consigneeMobile')?.touched
                  "
                />
                <label class="floating-label">Mobile *</label>
              </div>
            </div>

            <div class="flex gap-1">
              <div class="floating-group full-width">
                <input
                  type="text"
                  formControlName="consigneeAddress"
                  placeholder=" "
                  class="floating-input text-black"
                  [class.error]="
                    userInfoForm.get('consigneeAddress')?.invalid &&
                    userInfoForm.get('consigneeAddress')?.touched
                  "
                />
                <label class="floating-label">Consignee Address *</label>
              </div>
            </div>
          </div>
        </div>

        <!-- DELIVERY / PAYMENT -->
        <div class="flex gap-3 m-0">
          <div class="floating-group">
            <select
              formControlName="modeOfDelivery"
              class="floating-input text-black"
              [class.error]="
                userInfoForm.get('modeOfDelivery')?.invalid &&
                userInfoForm.get('modeOfDelivery')?.touched
              "
            >
              <option value="" disabled selected hidden></option>
              <option *ngFor="let option of modeOfDeliveryOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
            <label class="floating-label">Mode of Delivery *</label>
          </div>

          <div class="floating-group">
            <select
              formControlName="modeOfPayment"
              class="floating-input text-black"
              [class.error]="
                userInfoForm.get('modeOfPayment')?.invalid &&
                userInfoForm.get('modeOfPayment')?.touched
              "
            >
              <option value="" disabled selected hidden></option>
              <option *ngFor="let option of modeOfPaymentOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
            <label class="floating-label">Mode of Payment *</label>
          </div>
        </div>
      </form>
    </div>

    <!-- ITEMS SECTION -->
    <div class="section items-section">
      <h2>Add Items</h2>
      <form [formGroup]="itemForm">
        <div class="flex gap-1">
          <div class="floating-group">
            <input
              type="text"
              formControlName="description"
              placeholder=" "
              class="floating-input text-black"
              [class.error]="itemForm.get('description')?.invalid && itemForm.get('description')?.touched"
            />
            <label class="floating-label">Item Description *</label>
          </div>

          <div class="floating-group">
            <input
              type="number"
              formControlName="quantity"
              placeholder=" "
              class="floating-input text-black"
              [class.error]="itemForm.get('quantity')?.invalid && itemForm.get('quantity')?.touched"
            />
            <label class="floating-label">Quantity *</label>
          </div>

          <div class="floating-group">
            <input
              type="number"
              formControlName="unitWeight"
              placeholder=" "
              class="floating-input text-black"
            />
            <label class="floating-label">Unit Weight</label>
          </div>

          <div class="flex items-center">
            <button type="button" class="btn btn-success" (click)="addItem()">Add</button>
          </div>
        </div>
      </form>

      <!-- ITEMS TABLE -->
      <div class="items-table-wrapper" *ngIf="items.length > 0">
        <table class="items-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Quantity</th>
              <th>Unit Weight (kg)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of items" class="item-row">
              <td>{{ item.description }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.unitWeight || '-' }}</td>
              <td>
                <button type="button" class="btn btn-danger btn-sm" (click)="removeItem(item.id)">
                  Remove
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- <div class="no-items-message" *ngIf="items.length === 0">
        <p>No items added yet. Add items to create the invoice.</p>
      </div> -->
    </div>

          <!-- FINANCIAL DETAILS SECTION below Items -->
      <div class="section financial-details-section">
        <h3 class="sub-heading">Billing Details</h3>
        <form [formGroup]="financialForm">
          <div class="flex gap-1">
            <div class="floating-group">
              <input
                type="number"
                formControlName="totalCartons"
                placeholder=" "
                class="floating-input text-black"
                [class.error]="
                  financialForm.get('totalCartons')?.invalid &&
                  financialForm.get('totalCartons')?.touched
                "
              />
              <label class="floating-label">Total Cartons *</label>
            </div>

            <div class="floating-group">
              <input
                type="number"
                formControlName="totalWeight"
                placeholder=" "
                class="floating-input text-black"
                [class.error]="
                  financialForm.get('totalWeight')?.invalid &&
                  financialForm.get('totalWeight')?.touched
                "
              />
              <label class="floating-label">Total Weight *</label>
            </div>

            <div class="floating-group">
              <input
                type="number"
                formControlName="pricePerKg"
                placeholder=" "
                class="floating-input text-black"
                [class.error]="
                  financialForm.get('pricePerKg')?.invalid &&
                  financialForm.get('pricePerKg')?.touched
                "
              />
              <label class="floating-label">Price per Kg *</label>
            </div>
          </div>
        </form>
      </div>

    <!-- CHARGES SECTION -->
    <div class="section charges-section">
      <h2>Additional Charges & Discount</h2>
      <form [formGroup]="chargesForm">
        <div class="flex gap-1">
          <div class="floating-group">
            <input
              type="number"
              formControlName="customsCharge"
              placeholder=" "
              class="floating-input text-black"
              [class.error]="
                chargesForm.get('customsCharge')?.invalid && chargesForm.get('customsCharge')?.touched
              "
            />
            <label class="floating-label">Customs Charge</label>
          </div>

          <div class="floating-group">
            <input
              type="number"
              formControlName="billCharge"
              placeholder=" "
              class="floating-input text-black"
              [class.error]="
                chargesForm.get('billCharge')?.invalid && chargesForm.get('billCharge')?.touched
              "
            />
            <label class="floating-label">Bill Charge</label>
          </div>

          <div class="floating-group">
            <input
              type="number"
              formControlName="packingCharge"
              placeholder=" "
              class="floating-input text-black"
              [class.error]="
                chargesForm.get('packingCharge')?.invalid &&
                chargesForm.get('packingCharge')?.touched
              "
            />
            <label class="floating-label">Packing Charge</label>
          </div>

          <div class="floating-group">
            <input
              type="number"
              formControlName="discount"
              placeholder=" "
              class="floating-input text-black"
              [class.error]="
                chargesForm.get('discount')?.invalid && chargesForm.get('discount')?.touched
              "
            />
            <label class="floating-label">Discount</label>
          </div>
        </div>
      </form>
    </div>

    <!-- TOTALS SECTION -->
    <div class="section totals-section">
      <h2>Invoice Summary</h2>
      <div class="totals-grid">
        <div class="total-item">
          <span class="label">Subtotal:</span>
          <span class="value">{{ settingsService.currencySymbol() }}{{ subtotal.toFixed(2) }}</span>
        </div>
        <div class="total-item" *ngIf="customsCharge > 0">
          <span class="label">Customs Charge:</span>
          <span class="value positive"
            >+{{ settingsService.currencySymbol() }}{{ customsCharge.toFixed(2) }}</span
          >
        </div>
        <div class="total-item" *ngIf="billCharge > 0">
          <span class="label">Bill Charge:</span>
          <span class="value positive"
            >+{{ settingsService.currencySymbol() }}{{ billCharge.toFixed(2) }}</span
          >
        </div>
        <div class="total-item" *ngIf="packingCharge > 0">
          <span class="label">Packing Charge:</span>
          <span class="value positive"
            >+{{ settingsService.currencySymbol() }}{{ packingCharge.toFixed(2) }}</span
          >
        </div>
        <div class="total-item" *ngIf="discount > 0">
          <span class="label">Discount:</span>
          <span class="value negative"
            >-{{ settingsService.currencySymbol() }}{{ discount.toFixed(2) }}</span
          >
        </div>
        <div class="grand-total">
          <span class="label">Grand Total:</span>
          <span class="value"
            >{{ settingsService.currencySymbol() }}{{ grandTotal.toFixed(2) }}</span
          >
        </div>
      </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="section action-buttons">
      <button
        type="button"
        class="btn btn-primary btn-large"
        (click)="submitInvoice()"
        [disabled]="items.length === 0"
      >
        Create Invoice
      </button>
    </div>
  </div>
</div>
